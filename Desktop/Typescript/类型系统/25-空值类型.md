# 空值类型 (Null and Undefined Types)

## 概念定义
空值类型包括 `null` 和 `undefined`，它们表示值的缺失或未定义状态。

## 语法示例
```typescript
// 显式类型注解
let name: string | null = null;
let age: number | undefined = undefined;

// 变量声明
let undefinedValue: undefined = undefined;
let nullValue: null = null;

// 函数返回值
function findUser(id: number): User | null {
  // 可能返回 null
  return users.find(user => user.id === id) ?? null;
}
```

## 使用场景

### 1. 可选参数和属性
```typescript
// 接口中的可选属性
interface User {
  id: number;
  name: string;
  email?: string; // 可选，相当于 string | undefined
  phone: string | null; // 明确可能为 null
}

// 函数中的可选参数
function greet(name: string, title?: string) {
  return title ? `${title} ${name}` : name;
}
```

### 2. 数据初始化
```typescript
// 初始化状态
let data: Data | null = null;

// 异步加载数据
async function loadData() {
  data = await fetchData();
}

// 使用前检查
if (data !== null) {
  processData(data);
}
```

### 3. 错误处理
```typescript
// 返回 null 表示失败
function parseNumber(input: string): number | null {
  const num = Number(input);
  return isNaN(num) ? null : num;
}

// 使用结果
const result = parseNumber("123");
if (result !== null) {
  console.log(result * 2);
}
```

## 严格空值检查

### 1. tsconfig 配置
```json
{
  "compilerOptions": {
    "strictNullChecks": true, // 启用严格空值检查
    "exactOptionalPropertyTypes": true // 精确可选属性类型
  }
}
```

### 2. 严格模式下的行为
```typescript
// 启用 strictNullChecks 后
let name: string = null; // 错误: 不能将类型“null”分配给类型“string”
let age: number = undefined; // 错误: 不能将类型“undefined”分配给类型“number”

// 必须显式声明
let username: string | null = null;
let userAge: number | undefined = undefined;
```

## 空值处理模式

### 1. 空值合并运算符 (??)
```typescript
// 提供默认值
const name = inputName ?? "Anonymous";
const port = config.port ?? 8080;

// 与 || 的区别
const value = 0 ?? "default"; // 0
const value2 = 0 || "default"; // "default"
```

### 2. 可选链操作符 (?.)
```typescript
// 安全访问嵌套属性
const street = user?.address?.street;
const emailLength = user?.email?.length;

// 方法调用
const result = obj?.method?.();

// 数组访问
const firstItem = arr?.[0];
```

### 3. 空值断言 (!)
```typescript
// 告诉编译器值不为空
function processElement() {
  const element = document.getElementById("myElement")!; // 断言不为 null
  element.classList.add("active");
}

// 但需要确保确实不为空
const user = findUser(123)!;
console.log(user.name);
```

## 最佳实践

### 1. 避免隐式空值
```typescript
// 不良实践
function badExample(): string {
  // 可能返回 undefined
  return Math.random() > 0.5 ? "hello" : undefined;
}

// 良好实践
function goodExample(): string | undefined {
  return Math.random() > 0.5 ? "hello" : undefined;
}
```

### 2. 使用类型守卫
```typescript
// 自定义类型守卫
function isNotNull<T>(value: T | null): value is T {
  return value !== null;
}

function isDefined<T>(value: T | undefined): value is T {
  return value !== undefined;
}

// 使用守卫
const results = [1, null, 3, undefined, 5];
const validNumbers = results.filter(isNotNull); // [1, 3, 5]
```

### 3. 数据验证模式
```typescript
// 验证函数
function validateUser(user: User | null): user is User {
  return user !== null && 
         typeof user.name === "string" &&
         typeof user.age === "number";
}

// 使用验证
const candidate = findUser(123);
if (validateUser(candidate)) {
  // candidate 现在是 User 类型
  sendEmail(candidate.email);
}
```

## 常见错误

### 1. 误用空值断言
```typescript
// 危险的使用方式
function dangerous() {
  const element = document.getElementById("nonexistent")!;
  element.click(); // 运行时错误
}

// 安全的使用方式
function safe() {
  const element = document.getElementById("myElement");
  if (element) {
    element.click();
  }
}
```

### 2. 忽略严格空值检查
```typescript
// 没有启用 strictNullChecks
function oldStyle(): string {
  // 可能返回 undefined，但编译器不会报错
  return Math.random() > 0.5 ? "hello" : undefined;
}

// 启用 strictNullChecks 后
function newStyle(): string | undefined {
  return Math.random() > 0.5 ? "hello" : undefined;
}
```

## 实用工具类型

### 1. NonNullable
```typescript
// 移除 null 和 undefined
type Name = string | null | undefined;
type ValidName = NonNullable<Name>; // string

// 使用示例
function getValidValue<T>(value: T): NonNullable<T> {
  if (value === null || value === undefined) {
    throw new Error("Value cannot be null or undefined");
  }
  return value;
}
```

### 2. 条件类型处理
```typescript
// 条件类型处理空值
type Maybe<T> = T | null | undefined;

// 移除空值
type Definite<T> = T extends null | undefined ? never : T;

// 使用示例
function ensureDefinite<T>(value: Maybe<T>): Definite<T> {
  if (value === null || value === undefined) {
    throw new Error("Value is null or undefined");
  }
  return value;
}
```

## 性能考虑

### 1. 可选链的性能
```typescript
// 可选链操作符编译为安全检查
const value = obj?.prop?.subprop;

// 编译后相当于
const value = obj && obj.prop && obj.prop.subprop;
```

### 2. 空值检查的开销
```typescript
// 过多的空值检查可能影响性能
function processData(data: Data | null) {
  if (data === null) return;
  if (data.items === null) return;
  if (data.items.length === 0) return;
  // ...
}

// 考虑使用提前返回或守卫子句
```

## 总结
空值类型是 TypeScript 中重要的概念：

✅ **正确使用**:
- 显式声明可能为空的类型
- 使用严格空值检查
- 利用可选链和空值合并
- 编写类型安全的代码

❌ **避免**:
- 隐式返回空值
- 过度使用空值断言
- 忽略空值检查

**最佳实践**:
- 启用 `strictNullChecks`
- 使用类型守卫验证空值
- 优先使用可选链和空值合并
- 为可能为空的值提供明确的类型注解

---
**示例文件**: [examples/25-null-undefined.ts](../examples/25-null-undefined.ts)