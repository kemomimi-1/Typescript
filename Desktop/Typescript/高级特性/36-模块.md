# 36. 模块 (Modules)

## 概念定义

**模块**是 TypeScript 中组织代码的现代方式，它基于 ES6 模块标准。模块允许你将代码分割到不同的文件中，每个文件都是一个独立的模块，可以通过 `import` 和 `export` 关键字来共享代码。

## 语法示例

### 基础导出和导入
```typescript
// math.ts - 导出模块
const PI = 3.14159;

function circleArea(radius: number): number {
  return PI * radius * radius;
}

function circleCircumference(radius: number): number {
  return 2 * PI * radius;
}

// 命名导出
export { circleArea, circleCircumference };
export { PI };

// main.ts - 导入模块
import { circleArea, circleCircumference, PI } from './math';

console.log("PI:", PI);
console.log("Area:", circleArea(5));
console.log("Circumference:", circleCircumference(5));
```

### 默认导出
```typescript
// logger.ts - 默认导出
export default class Logger {
  log(message: string) {
    console.log(`[LOG] ${new Date().toISOString()}: ${message}`);
  }
}

// config.ts - 默认导出对象
export default {
  appName: "My App",
  version: "1.0.0",
  environment: process.env.NODE_ENV || "development"
};

// main.ts - 导入默认导出
import Logger from './logger';
import config from './config';

const logger = new Logger();
logger.log(`Starting ${config.appName} v${config.version}`);
```

### 重新导出
```typescript
// shapes.ts
export class Circle {
  constructor(public radius: number) {}
  area() { return Math.PI * this.radius ** 2; }
}

export class Square {
  constructor(public side: number) {}
  area() { return this.side ** 2; }
}

// geometry.ts - 重新导出
export { Circle, Square } from './shapes';
export * from './shapes'; // 重新导出所有

export function calculateTotalArea(shapes: any[]): number {
  return shapes.reduce((total, shape) => total + shape.area(), 0);
}

// main.ts
import { Circle, Square, calculateTotalArea } from './geometry';

const shapes = [new Circle(5), new Square(4)];
console.log("Total area:", calculateTotalArea(shapes));
```

## 使用场景

### 1. 组件化架构
```typescript
// components/Button.tsx
export interface ButtonProps {
  label: string;
  onClick?: () => void;
  variant?: 'primary' | 'secondary';
}

export default function Button({ label, onClick, variant = 'primary' }: ButtonProps) {
  return (
    <button 
      className={`btn btn-${variant}`}
      onClick={onClick}
    >
      {label}
    </button>
  );
}

// components/Input.tsx
export interface InputProps {
  value: string;
  onChange: (value: string) => void;
  placeholder?: string;
}

export default function Input({ value, onChange, placeholder }: InputProps) {
  return (
    <input
      type="text"
      value={value}
      onChange={(e) => onChange(e.target.value)}
      placeholder={placeholder}
    />
  );
}

// App.tsx
import Button, { ButtonProps } from './components/Button';
import Input, { InputProps } from './components/Input';

function App() {
  const [inputValue, setInputValue] = useState('');
  
  return (
    <div>
      <Input 
        value={inputValue} 
        onChange={setInputValue}
        placeholder="Enter text..."
      />
      <Button 
        label="Submit" 
        onClick={() => console.log(inputValue)}
      />
    </div>
  );
}
```

### 2. 服务层模块化
```typescript
// services/api.ts
export interface ApiResponse<T> {
  data: T;
  status: number;
  message?: string;
}

export async function get<T>(url: string): Promise<ApiResponse<T>> {
  const response = await fetch(url);
  const data = await response.json();
  return { data, status: response.status };
}

export async function post<T>(url: string, body: any): Promise<ApiResponse<T>> {
  const response = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  const data = await response.json();
  return { data, status: response.status };
}

// services/userService.ts
import { get, post } from './api';

export interface User {
  id: number;
  name: string;
  email: string;
}

export class UserService {
  static async getUsers(): Promise<User[]> {
    const response = await get<User[]>('/api/users');
    return response.data;
  }
  
  static async createUser(user: Omit<User, 'id'>): Promise<User> {
    const response = await post<User>('/api/users', user);
    return response.data;
  }
}

// usage.ts
import { UserService } from './services/userService';

async function loadUsers() {
  try {
    const users = await UserService.getUsers();
    console.log('Users:', users);
  } catch (error) {
    console.error('Failed to load users:', error);
  }
}
```

### 3. 工具函数库
```typescript
// utils/stringUtils.ts
export function capitalize(str: string): string {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

export function truncate(str: string, maxLength: number): string {
  if (str.length <= maxLength) return str;
  return str.slice(0, maxLength) + '...';
}

export function camelCase(str: string): string {
  return str.replace(/[-_\s]+(.)?/g, (_, c) => 
    c ? c.toUpperCase() : ''
  );
}

// utils/dateUtils.ts
export function formatDate(date: Date, format: string = 'YYYY-MM-DD'): string {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  
  return format
    .replace('YYYY', String(year))
    .replace('MM', month)
    .replace('DD', day);
}

export function addDays(date: Date, days: number): Date {
  const result = new Date(date);
  result.setDate(result.getDate() + days);
  return result;
}

// utils/index.ts - 桶文件
export * from './stringUtils';
export * from './dateUtils';

// main.ts
import { capitalize, formatDate, addDays } from './utils';

console.log(capitalize('hello world')); // "Hello world"
console.log(formatDate(new Date())); // "2024-01-20"
console.log(addDays(new Date(), 7)); // 7天后的日期
```

## 注意事项

### 模块解析
TypeScript 支持不同的模块解析策略：
```json
{
  "compilerOptions": {
    "module": "commonjs",        // Node.js
    "module": "es2015",          // ES6 模块
    "module": "amd",             // 异步模块定义
    "moduleResolution": "node",  // Node.js 模块解析
    "baseUrl": "./",             // 基础路径
    "paths": {                   // 路径映射
      "@/*": ["src/*"]
    }
  }
}
```

### 循环依赖
```typescript
// moduleA.ts
export function a() {
  return 'A';
}

import { b } from './moduleB';
export function aPlusB() {
  return a() + b();
}

// moduleB.ts
export function b() {
  return 'B';
}

import { a } from './moduleA';
export function bPlusA() {
  return b() + a();
}

// 避免循环依赖，使用函数延迟导入
```

### 最佳实践
```typescript
// 1. 使用具名导出代替默认导出（便于重构和代码搜索）
export function calculate() {}
export const CONSTANT = 'value';

// 2. 使用桶文件组织相关导出
// utils/index.ts
export * from './stringUtils';
export * from './dateUtils';

// 3. 使用路径别名避免相对路径混乱
import { UserService } from '@/services/UserService';
import { formatDate } from '@/utils';

// 4. 按功能而不是类型组织模块
// 好的：/features/user/ 包含所有用户相关代码
// 不好的：/components/, /services/, /models/ 按类型分隔
```

### 模块与命名空间
```typescript
// 使用模块（现代方式）
// math.ts
export function add(a: number, b: number) { return a + b; }

// 使用命名空间（传统方式）
// math.ts
namespace MathUtils {
  export function add(a: number, b: number) { return a + b; }
}

// 推荐使用模块，除非有特殊需求
```

## 示例代码位置

相关示例代码请查看：`examples/36-modules.ts`

---

**上一节**: [35-命名空间](./35-命名空间.md)  
**下一节**: [37-类型兼容性](./37-类型兼容性.md)  
**返回目录**: [高级特性目录](../高级特性/)